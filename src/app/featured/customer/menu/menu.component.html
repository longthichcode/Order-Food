<app-customer-header></app-customer-header>
<div class="container mt-4">
  <!-- Tiêu đề -->
  <div class="text-center mb-5">
    <h2 class="fw-bold display-6">Thực Đơn</h2>
    <p class="text-muted">Khám phá những món ăn ngon với hương vị đặc trưng của ẩm thực Việt Nam</p>
  </div>

  <!-- Bộ lọc -->
  <div *ngIf="!loading" class="row mb-4 g-3">
    <!-- Tìm theo tên -->
    <div class="col-md-4 col-12">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Tìm kiếm món ăn</mat-label>
        <input matInput placeholder="Nhập tên món..." (input)="searchByName($event)">
      </mat-form-field>
    </div>

    <!-- Danh mục -->
    <div class="col-md-4 col-12">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Danh mục</mat-label>
        <mat-select [(ngModel)]="selectedCategory" (selectionChange)="filterByCategory($event.value)">
          <mat-option value="0">Tất cả</mat-option>
          <mat-option *ngFor="let category of listCategory" [value]="category.categoryId">
            {{ category.categoryName }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Mức giá -->
    <div class="col-md-4 col-12">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Mức giá</mat-label>
        <mat-select [(ngModel)]="filterPrice" (selectionChange)="applyFilters()">
          <mat-option value="">Tất cả</mat-option>
          <mat-option value="low">Dưới 30.000đ</mat-option>
          <mat-option value="mid">30.000đ - 70.000đ</mat-option>
          <mat-option value="high">Trên 70.000đ</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary"></div>
    <p class="mt-3">Đang tải dữ liệu...</p>
  </div>

  <!-- Lỗi -->
  <div *ngIf="messageErr" class="alert alert-danger text-center">
    {{ messageErr }}
  </div>

  <!-- Danh sách món ăn -->
  <div class="row g-4">
    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12" *ngFor="let food of allFoods">
      <div class="card food-card h-100 shadow-sm" (click)="openModalReview(food)">
        <div class="img-wrapper">
          <img [src]="'assets/' + food.imageUrl" class="card-img-top food-img" alt="{{ food.name }}">
          <span class="badge bg-danger new-badge" *ngIf="food.isPromotion"><i class="bi bi-percent"></i> Khuyến
            mãi</span>
          <span class="badge star-badge" style="background-color: rgba(240, 248, 255, 0);">{{food.averageRating}}<i
              class="bi bi-star-fill" style="color: rgb(255, 238, 0);"></i> ({{food.reviewCount}}) </span>
        </div>
        <div class="card-body d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="card-title fw-bold mb-0">{{ food.name }}</h5>
            <span class="badge bg-light border text-dark p-2">{{ food.category?.categoryName }}</span>
          </div>
          <p class="card-text text-muted small flex-grow-1 p-0 m-0" style="color: rgba(161, 161, 161, 0.237);">{{
            food.description }}</p>
          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-bold text-danger price-tag">{{ formatPrice(food.price) }}</span>
            <span class="badge" [ngClass]="food.status === 'AVAILABLE' ? 'text-success' : 'text-danger'">
              {{ food.status === 'AVAILABLE' ? 'Còn hàng' : 'Hết hàng' }}
            </span>
          </div>
        </div>
        <div class="card-footer bg-white text-center">
          <button mat-raised-button color="primary" class="btn-animated" [disabled]="food.status !== 'AVAILABLE'"
            (click)="toggleCartForm(food.foodId)">
            <i class="bi bi-cart3"></i> Thêm vào giỏ
          </button>
          <!-- Form nhập số lượng và lưu ý -->
          <div *ngIf="selectedFoodId === food.foodId" class="mt-3">
            <div class="mb-2 text-start">
              <label class="form-label small">Số lượng</label>
              <input type="number" min="1" [(ngModel)]="quantity" class="form-control form-control-sm">
            </div>
            <div class="mb-2 text-start">
              <label class="form-label small">Lưu ý</label>
              <input type="text" [(ngModel)]="note" class="form-control form-control-sm"
                placeholder="Ví dụ: ít cay, thêm rau...">
            </div>
            <button class="btn btn-success btn-sm w-100" (click)="addToCart(food.foodId, quantity, note)">
              Xác nhận
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL HIỂN THỊ ĐÁNH GIÁ -->
<div class="modal fade" id="reviewModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-chat-dots-fill me-2"></i>
          Đánh giá - {{ selectedFood?.name }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <!-- Thông tin món -->
        <div class="text-center mb-4 p-3 bg-light rounded border-bottom">
          <img [src]="`assets/`+selectedFood?.imageUrl" width="100%" style="border-radius: 25px;" alt="">
          <div class="d-flex pt-3 ps-2 pe-2 justify-content-between">
            <div class="text-start d-flex flex-column">
              <strong style="font-size: large;" class="text-start">{{selectedFood?.name}}</strong>
              <p class="small text-muted ms-1 p-0">{{selectedFood?.description}}</p>
            </div>
            <span>{{selectedFood?.averageRating}}<i class="bi bi-star-fill" style="color: rgb(255, 238, 0);"></i> (
              {{selectedFood?.reviewCount}} đánh giá )</span>
          </div>
          <div class="text-start ms-2">
            <span class="fw-bold text-danger price-tag">{{ formatPrice(selectedFood?.price) }} </span> <span
              class="ms-3 text-muted">({{selectedFood?.orderCount}} đã mua)</span>
          </div>
        </div>

        <!-- Danh sách đánh giá -->
        <div *ngIf="selectedFood?.reviewCount; else noReview">
          <div *ngFor="let review of reviewsOfFood" class="border-bottom pb-3 mb-3">
            <div class="d-flex justify-content-between align-items-start">
              <div class="d-flex align-item-center justify-content-between">
                <div class="mt-2 ms-3 p-0">
                  <img src="assets/user_man.jpg" width="40px" *ngIf="review.user.gender == 'MALE' " alt="">
                </div>
                <div class="ms-3 d-flex flex-column">
                  <div>
                    <strong>
                      {{ review.user.fullName || 'Khách hàng' }}
                    </strong>
                    <span class="text-muted small" *ngIf="review.user.username == userName"> ( Bạn ) </span>
                  </div>

                  <div class="d-flex align-items-start">
                    <span class="mb-0 pt-0 text-muted flex-grow-1"
                      [innerHTML]="review.comment || 'Không có nhận xét'"></span>

                    <!-- Dropdown -->
                    <div class="review-dropdown ms-2" *ngIf="review.user.username == userName">
                      <button class="dots-btn">'''</button>

                      <div class="dropdown-content">
                        <button class="dropdown-item-edit" (click)="startEdit(review)">
                          <i class="bi bi-pencil-square me-2"></i> Chỉnh sửa
                        </button>
                        <button class="dropdown-item-delete" (click)="startDelete(review.reviewId)">
                          <i class="bi bi-trash me-2"></i> Xoá
                        </button>
                      </div>
                    </div>
                  </div>

                  <!-- FORM CHỈNH SỬA  -->
                  <div *ngIf="editingReviewId === review.reviewId" class="mt-3 p-3 bg-light border rounded">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <strong class="small">Chỉnh sửa đánh giá</strong>
                      <button class="btn btn-sm btn-outline-danger" (click)="cancelEdit()">×</button>
                    </div>

                    <textarea class="form-control form-control-sm mb-2" rows="2" [(ngModel)]="editForm.comment"
                      placeholder="Sửa lại nhận xét..."></textarea>

                    <div class="d-flex justify-content-between align-items-center">
                      <div class="star-rating">
                        <i class="bi bi-star-fill text-warning me-1 cursor-pointer" style="font-size: small;"
                          *ngFor="let n of [1,2,3,4,5]" [class.text-muted]="n > editForm.rating"
                          (click)="editForm.rating = n">
                        </i>
                        <span class="ms-2 small fw-bold">{{editForm.rating || 0}}/5</span>
                      </div>

                      <button class="btn btn-primary btn-sm" (click)="saveEdit(review.reviewId)"
                        [disabled]="!editForm.rating || editForm.comment.trim().length === 0">
                        Lưu
                      </button>
                    </div>
                  </div>

                  <!-- FORM XÁC NHẬN XOÁ -->
                  <div *ngIf="deleteReviewId === review.reviewId"
                    class="mt-3 p-3 bg-danger bg-opacity-10 border border-danger rounded">
                    <div class="d-flex align-items-center mb-3">
                      <i class="bi bi-exclamation-triangle-fill text-danger me-2 fs-4"></i>
                      <strong class="text-danger">Xác nhận xoá đánh giá này?</strong>
                    </div>

                    <p class="small text-muted mb-3">
                      Hành động này <strong>không thể hoàn tác</strong>.
                    </p>

                    <div class="d-flex justify-content-end gap-2">
                      <button class="btn btn-secondary btn-sm" (click)="cancelDelete()">
                        Huỷ
                      </button>
                      <button class="btn btn-danger btn-sm" (click)="confirmDelete(review.reviewId)">
                        <i class="bi bi-trash me-1"></i>
                        Xoá vĩnh viễn
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="text-end">
                <small class="text-muted">{{review.createdAt| date: 'dd/MM/yyyy HH:mm'}}</small>
                <div class="text-warning">
                  <i class="bi bi-star-fill" *ngFor="let star of [].constructor(review.rating)"></i>
                  <i class="bi bi-star" *ngFor="let star of [].constructor(5 - review.rating)"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- nhập đánh giá -->
        <div class="mt-4 p-3 border rounded bg-light">
          <!-- tên người dùng hiện tại -->
          <div class="d-flex align-items-center mb-3">
            <div>
              <strong>{{ userName }}</strong>
            </div>
          </div>

          <div class=" d-flex justify-content-between align-item-center">
            <!-- Nội dung đánh giá -->
            <div class="" style="width: 60%;">
              <textarea id="reviewComment" class="form-control" rows="2"
                placeholder="Chia sẻ trải nghiệm của bạn về món ăn này..." [(ngModel)]="newReviewForm.comment"
                [ngClass]="{'is-invalid': newReviewForm.comment.trim().length === 0 && submitted}">
                </textarea>
              <div class="invalid-feedback">
                Vui lòng nhập nhận xét
              </div>
            </div>

            <!-- Chọn số sao -->
            <div class="">
              <div class="star-rating d-flex flex-column">
                <div class="text-center">
                  <i class="bi bi-star-fill text-center fs-3 text-warning ps-1 pe-1 cursor-pointer"
                    *ngFor="let star of [1,2,3,4,5]; let i = index"
                    [class.text-warning]="i < hoveredStar || i < newReviewForm.rating"
                    [class.text-muted]="i >= hoveredStar && i >= newReviewForm.rating" (click)="setRating(i + 1)"
                    (mouseenter)="hoveredStar = i + 1" (mouseleave)="hoveredStar = 0">
                  </i>
                </div>
                <span class="text-center fw-bold" [ngClass]="{'text-danger': newReviewForm.rating === 0 && submitted}">
                  {{ newReviewForm.rating ? newReviewForm.rating + '/5 sao' : 'Chưa chọn sao' }}
                </span>
              </div>
            </div>

            <!-- Nút gửi -->
            <div class="text-end mt-3">
              <button type="button" class="btn btn-primary px-4" (click)="submitReview()" [disabled]="isSubmitting">
                <span *ngIf="!isSubmitting">
                  <i class="bi bi-send-fill"></i>
                </span>
                <span *ngIf="isSubmitting">
                  <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                  Đang gửi...
                </span>
              </button>
            </div>
          </div>


        </div>

        <ng-template #noReview>
          <div class="text-center py-5 text-muted">
            <i class="bi bi-chat-square-text display-1"></i>
            <p class="mt-3">Chưa có đánh giá nào</p>
            <small>Hãy là người đầu tiên đánh giá món này!</small>
          </div>
        </ng-template>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>